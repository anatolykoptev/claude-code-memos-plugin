#!/usr/bin/env bash
# setup.sh — Interactive setup for claude-code-memos plugin
set -euo pipefail

CONFIG_DIR="${HOME}/.config/claude-code-memos"
CONFIG_FILE="${CONFIG_DIR}/config.env"

echo ""
echo "=== claude-code-memos setup ==="
echo ""
echo "This will configure your MemOS connection for Claude Code."
echo "Config will be saved to: ${CONFIG_FILE}"
echo ""

# --- Prompt for values ---

read -rp "MemOS API URL [http://127.0.0.1:8000]: " api_url
api_url="${api_url:-http://127.0.0.1:8000}"

read -rp "User ID [default]: " user_id
user_id="${user_id:-default}"

read -rp "Cube ID [memos]: " cube_id
cube_id="${cube_id:-memos}"

read -rp "Internal service secret (optional, press Enter to skip): " secret
secret="${secret:-}"

# --- Test connectivity ---

echo ""
echo "Testing connection to ${api_url}/product/scheduler/allstatus ..."

if curl -sf --max-time 5 "${api_url}/product/scheduler/allstatus" > /dev/null 2>&1; then
  echo "OK — MemOS is reachable."
else
  echo "WARNING: Could not reach ${api_url}/product/scheduler/allstatus"
  echo "The config will still be saved. You can re-run setup.sh later."
  read -rp "Continue anyway? [Y/n]: " cont
  if [[ "${cont,,}" == "n" ]]; then
    echo "Aborted."
    exit 1
  fi
fi

# --- Write config ---

mkdir -p "${CONFIG_DIR}"
cat > "${CONFIG_FILE}" <<EOF
# claude-code-memos plugin configuration
# Generated by setup.sh on $(date -Iseconds)
MEMOS_API_URL=${api_url}
MEMOS_USER_ID=${user_id}
MEMOS_CUBE_ID=${cube_id}
EOF

if [[ -n "${secret}" ]]; then
  echo "INTERNAL_SERVICE_SECRET=${secret}" >> "${CONFIG_FILE}"
fi

chmod 600 "${CONFIG_FILE}"

echo ""
echo "Config saved to ${CONFIG_FILE}"
echo ""
echo "Next steps:"
echo "  1. Restart Claude Code (or start a new session)"
echo "  2. You should see 'MemOS memory connected' at session start"
echo "  3. Your memories will be automatically injected on each prompt"
echo ""
echo "To reconfigure, run this script again."
echo "To uninstall, delete ${CONFIG_DIR}"
echo ""
